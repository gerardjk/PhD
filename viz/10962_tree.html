<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ISO 10962 — CFI Tree</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    body { margin: 0; padding: 20px; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #fff; }
    #container { display: flex; justify-content: center; align-items: center; }

    .controls {
      position: absolute; top: 20px; left: 20px;
      display: flex; gap: 10px; flex-wrap: wrap;
      background: rgba(255,255,255,.9); padding: 8px 10px;
      border: 1px solid #ccc; border-radius: 6px; font: 12px/1.2 sans-serif;
      user-select: none;
    }
    .legend {
      position: absolute; top: 20px; right: 20px;
      background: rgba(255,255,255,.9); padding: 10px;
      border: 1px solid #ccc; border-radius: 6px; font: 12px/1.2 sans-serif;
      min-width: 200px;
    }
    .legend-item { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .legend-color { width: 20px; height: 10px; border: 1px solid #999; }

    .link { fill: none; stroke-opacity: .45; stroke-width: 1.5; stroke: #000; }
    .link--active { stroke-opacity: 1; stroke-width: 2; }
    .link-extension--active { stroke-opacity: .6; }

    text { font: 10px sans-serif; fill: #111; }
    .label--active { font-weight: 700; }
    .text-halo { paint-order: stroke; stroke: #fff; stroke-width: 3px; }

    .notice, .error {
      position: absolute; left: 20px; right: 20px;
      border-radius: 6px; padding: 10px 12px; font: 13px/1.3 sans-serif;
    }
    .notice { top: 20px; background: #f7fbff; border: 1px solid #cbe3ff; color: #003e7e; }
    .error  { top: 70px; background: #fff3f3; border: 1px solid #e7bcbc; color: #a40000; }
    #picker { position: absolute; top: 120px; left: 20px; background: #fff; border: 1px dashed #aaa; padding: 10px; border-radius: 6px; }
    #picker input[type=file] { font-size: 13px; }
  </style>
</head>
<body>
  <div class="controls">
    <label>Color by:
      <select id="color-mode">
        <option value="category" selected>Category (1st char)</option>
        <option value="depth">Depth (levels)</option>
      </select>
    </label>
  </div>

  <div id="container"></div>
  <div class="legend" id="legend"></div>

  <div id="notice" class="notice" style="display:none">
    You’re viewing this page via <code>file://</code>. Browsers block <code>fetch()</code> for local files.
    Either run a local server, or use the file picker below to load <code>cfi_table_hierarchy.json</code>.
  </div>
  <div id="err" class="error" style="display:none"></div>

  <div id="picker" style="display:none">
    <label>Load JSON file:
      <input type="file" id="jsonFile" accept=".json">
    </label>
  </div>

  <script>
    // Embedded CFI data
    const embeddedCFI = {
  "name": "ISO 10962 (CFI) – Tabulated structure",
  "source": "Wikipedia: ISO 10962 (Tabulated Structure of CFI Code)",
  "schema": "Level1=Category, Level2=Group, Level3-6=Attributes per group",
  "categories": [
    {
      "code": "E",
      "name": "Equities",
      "groups": [
        {
          "code": "S",
          "name": "Shares (Common / Ordinary)",
          "attributes": [
            {
              "position": 3,
              "name": "Voting Right",
              "values": {
                "V": "Voting",
                "N": "Non-Voting",
                "R": "Restricted",
                "E": "Enhanced voting"
              }
            },
            {
              "position": 4,
              "name": "Ownership",
              "values": {
                "T": "Restrictions",
                "U": "Free"
              }
            },
            {
              "position": 5,
              "name": "Payment Status",
              "values": {
                "F": "Fully Paid",
                "O": "Nil Paid",
                "P": "Partly Paid"
              }
            },
            {
              "position": 6,
              "name": "Form",
              "values": {
                "B": "Bearer",
                "R": "Registered",
                "N": "Bearer/Registered",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "P",
          "name": "Preferred shares",
          "attributes": [
            {
              "position": 3,
              "name": "Voting Right",
              "values": {
                "V": "Voting",
                "N": "Non-Voting",
                "R": "Restricted",
                "E": "Enhanced voting"
              }
            },
            {
              "position": 4,
              "name": "Redemption",
              "values": {
                "R": "Redeemable",
                "E": "Extendible",
                "T": "Redeemable / Extendible",
                "G": "Exchangeable",
                "A": "Redeemable / Exchangeable / Extendible",
                "C": "Redeemable / Exchangeable",
                "N": "Perpetual"
              }
            },
            {
              "position": 5,
              "name": "Income",
              "values": {
                "F": "Fixed Rate",
                "C": "Cumulative, Fixed Rate",
                "P": "Participating",
                "Q": "Cumulative, Participating",
                "A": "Adjustable/Variable Rate",
                "N": "Normal Rate",
                "U": "Auction Rate",
                "D": "Dividends"
              }
            },
            {
              "position": 6,
              "name": "Form",
              "values": {
                "B": "Bearer",
                "R": "Registered",
                "N": "Bearer/Registered",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "C",
          "name": "Convertible shares",
          "attributes": [
            {
              "position": 3,
              "name": "Voting Right",
              "values": {
                "V": "Voting",
                "N": "Non-Voting",
                "R": "Restricted",
                "E": "Enhanced voting"
              }
            },
            {
              "position": 4,
              "name": "Ownership",
              "values": {
                "T": "Restrictions",
                "U": "Free"
              }
            },
            {
              "position": 5,
              "name": "Payment Status",
              "values": {
                "F": "Fully Paid",
                "O": "Nil Paid",
                "P": "Partly Paid"
              }
            },
            {
              "position": 6,
              "name": "Form",
              "values": {
                "B": "Bearer",
                "R": "Registered",
                "N": "Bearer/Registered",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "F",
          "name": "Preferred convertible shares",
          "attributes": [
            {
              "position": 3,
              "name": "Voting Right",
              "values": {
                "V": "Voting",
                "N": "Non-Voting",
                "R": "Restricted",
                "E": "Enhanced voting"
              }
            },
            {
              "position": 4,
              "name": "Redemption",
              "values": {
                "R": "Redeemable",
                "E": "Extendible",
                "T": "Redeemable / Extendible",
                "G": "Exchangeable",
                "A": "Redeemable / Exchangeable / Extendible",
                "C": "Redeemable / Exchangeable",
                "N": "Perpetual"
              }
            },
            {
              "position": 5,
              "name": "Income",
              "values": {
                "F": "Fixed Rate",
                "C": "Cumulative, Fixed Rate",
                "P": "Participating",
                "Q": "Cumulative, Participating",
                "A": "Adjustable/Variable Rate",
                "N": "Normal Rate",
                "U": "Auction Rate",
                "D": "Dividends"
              }
            },
            {
              "position": 6,
              "name": "Form",
              "values": {
                "B": "Bearer",
                "R": "Registered",
                "N": "Bearer/Registered",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "L",
          "name": "Limited partnership units",
          "attributes": [
            {
              "position": 3,
              "name": "Voting Right",
              "values": {
                "V": "Voting",
                "N": "Non-Voting",
                "R": "Restricted",
                "E": "Enhanced voting"
              }
            },
            {
              "position": 4,
              "name": "Ownership",
              "values": {
                "T": "Restrictions",
                "U": "Free"
              }
            },
            {
              "position": 5,
              "name": "Payment Status",
              "values": {
                "F": "Fully Paid",
                "O": "Nil Paid",
                "P": "Partly Paid"
              }
            },
            {
              "position": 6,
              "name": "Form",
              "values": {
                "B": "Bearer",
                "R": "Registered",
                "N": "Bearer/Registered",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "D",
          "name": "Depository receipts on equities",
          "attributes": [
            {
              "position": 3,
              "name": "Instrument dependency",
              "values": {
                "S": "Common/Ordinary Shares",
                "P": "Preferred/Preference Shares",
                "C": "Common/Ordinary Convertible Shares",
                "F": "Preferred/Preference Convertible Shares",
                "L": "Limited Partnership Units",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 4,
              "name": "Redemption / Conversion of the Underlying Asset",
              "values": {
                "R": "Redeemable",
                "N": "Perpetual",
                "B": "Convertible",
                "D": "Convertible/Redeemable",
                "X": "Not Appl./Undefined"
              }
            },
            {
              "position": 5,
              "name": "Income",
              "values": {
                "F": "Fixed Rate",
                "C": "Cumulative, Fixed Rate",
                "P": "Participating",
                "Q": "Cumulative, Participating",
                "A": "Adjustable/Variable Rate",
                "N": "Normal Rate",
                "U": "Auction Rate",
                "D": "Dividends"
              }
            },
            {
              "position": 6,
              "name": "Form",
              "values": {
                "B": "Bearer",
                "R": "Registered",
                "N": "Bearer/Registered",
                "M": "Others (Misc.)"
              }
            }
          ]
        }
      ]
    },
    {
      "code": "D",
      "name": "Debt Instruments",
      "groups": [
        {
          "code": "B",
          "name": "Bonds",
          "attributes": [
            {
              "position": 3,
              "name": "Type of interest",
              "values": {
                "F": "Fixed rate",
                "Z": "Zero rate / discounted rate",
                "V": "Variable",
                "C": "Cash payment",
                "K": "Payment in kind"
              }
            },
            {
              "position": 4,
              "name": "Guarantee",
              "values": {
                "T": "Government / State Guarantee",
                "G": "Joint Guarantee",
                "S": "Secured",
                "U": "Unsecured / Unguaranteed",
                "P": "Negative Pledge",
                "N": "Senior",
                "O": "Senior Subordinated",
                "Q": "Junior",
                "J": "Junior Subordinated",
                "C": "Supranational"
              }
            },
            {
              "position": 5,
              "name": "Redemption/Reimbursement",
              "values": {
                "F": "Fixed Maturity",
                "G": "Fixed Maturity with Call Feature",
                "C": "Fixed Maturity with Put Feature",
                "D": "Fixed Maturity with Put and Call",
                "A": "Amortization Plan",
                "B": "Amortization Plan with Call Feature",
                "T": "Amortization Plan with Put Feature",
                "L": "Amortization Plan with Put and Call",
                "P": "Perpetual",
                "Q": "Perpetual with Call Feature",
                "R": "Perpetual with Put Feature",
                "E": "Extendible"
              }
            },
            {
              "position": 6,
              "name": "Form",
              "values": {
                "B": "Bearer",
                "R": "Registered",
                "N": "Bearer/Registered",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "C",
          "name": "Convertible Bonds",
          "attributes": []
        },
        {
          "code": "W",
          "name": "Bonds with warrants attached",
          "attributes": []
        },
        {
          "code": "T",
          "name": "Medium-term notes",
          "attributes": []
        },
        {
          "code": "S",
          "name": "Structured products (with capital protection)",
          "attributes": [
            {
              "position": 3,
              "name": "Type",
              "values": {
                "A": "Capital Protection Certificate with Participation",
                "B": "Capital Protection Convertible Certificate",
                "C": "Barrier Capital Protection Certificate",
                "D": "Capital Protection Certificate with Coupons",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 4,
              "name": "Distribution",
              "values": {
                "F": "Fixed Interest Payments",
                "D": "Dividend Payments",
                "V": "Variable Interest Payments",
                "Y": "No Payments",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 5,
              "name": "Repayment",
              "values": {
                "F": "Fixed Cash Repayment (Only Protected Capital Level)",
                "V": "Variable Cash Repayment",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 6,
              "name": "Underlying asset",
              "values": {
                "B": "Baskets",
                "S": "Equities",
                "D": "Debt Instruments / Interest Rates",
                "T": "Commodities",
                "C": "Currencies",
                "I": "Indices",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "E",
          "name": "Structured products (without capital protection)",
          "attributes": [
            {
              "position": 3,
              "name": "Type",
              "values": {
                "A": "Discount Certificate",
                "B": "Barrier Discount Certificate",
                "C": "Reverse Convertible",
                "D": "Barrier Reverse Convertible",
                "E": "Express Certificate",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 4,
              "name": "Repayment",
              "values": {
                "R": "Repayment in Cash",
                "S": "Repayment in Assets",
                "C": "Repayment in Assets and Cash",
                "T": "Repayment in Assets or Cash",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 5,
              "name": "Type of interest",
              "values": {
                "F": "Fixed rate",
                "Z": "Zero rate / discounted rate",
                "V": "Variable"
              }
            },
            {
              "position": 6,
              "name": "Guarantee",
              "values": {
                "T": "Government / State Guarantee",
                "G": "Joint Guarantee",
                "S": "Secured",
                "U": "Unsecured / Unguaranteed",
                "P": "Negative Pledge",
                "N": "Senior",
                "O": "Senior Subordinated",
                "Q": "Junior",
                "J": "Junior Subordinated",
                "C": "Supranational"
              }
            }
          ]
        },
        {
          "code": "G",
          "name": "Mortgage-backed securities (MBS)",
          "attributes": [
            {
              "position": 3,
              "name": "Type of interest",
              "values": {
                "F": "Fixed rate",
                "Z": "Zero rate / discounted rate",
                "V": "Variable",
                "C": "Cash payment",
                "K": "Payment in kind"
              }
            },
            {
              "position": 4,
              "name": "Guarantee",
              "values": {
                "T": "Government / State Guarantee",
                "G": "Joint Guarantee",
                "S": "Secured",
                "U": "Unsecured / Unguaranteed",
                "P": "Negative Pledge",
                "N": "Senior",
                "O": "Senior Subordinated",
                "Q": "Junior",
                "J": "Junior Subordinated",
                "C": "Supranational"
              }
            },
            {
              "position": 5,
              "name": "Redemption/Reimbursement",
              "values": {
                "F": "Fixed Maturity",
                "G": "Fixed Maturity with Call Feature",
                "C": "Fixed Maturity with Put Feature",
                "D": "Fixed Maturity with Put and Call",
                "A": "Amortization Plan",
                "B": "Amortization Plan with Call Feature",
                "T": "Amortization Plan with Put Feature",
                "L": "Amortization Plan with Put and Call",
                "P": "Perpetual",
                "Q": "Perpetual with Call Feature",
                "R": "Perpetual with Put Feature",
                "E": "Extendible"
              }
            },
            {
              "position": 6,
              "name": "Form",
              "values": {
                "B": "Bearer",
                "R": "Registered",
                "N": "Bearer/Registered",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "A",
          "name": "Asset backed securities (ABS)",
          "attributes": [
            {
              "position": 3,
              "name": "Type of interest",
              "values": {
                "F": "Fixed rate",
                "Z": "Zero rate / discounted rate",
                "V": "Variable",
                "C": "Cash payment",
                "K": "Payment in kind"
              }
            },
            {
              "position": 4,
              "name": "Guarantee",
              "values": {
                "T": "Government / State Guarantee",
                "G": "Joint Guarantee",
                "S": "Secured",
                "U": "Unsecured / Unguaranteed",
                "P": "Negative Pledge",
                "N": "Senior",
                "O": "Senior Subordinated",
                "Q": "Junior",
                "J": "Junior Subordinated",
                "C": "Supranational"
              }
            },
            {
              "position": 5,
              "name": "Redemption/Reimbursement",
              "values": {
                "F": "Fixed Maturity",
                "G": "Fixed Maturity with Call Feature",
                "C": "Fixed Maturity with Put Feature",
                "D": "Fixed Maturity with Put and Call",
                "A": "Amortization Plan",
                "B": "Amortization Plan with Call Feature",
                "T": "Amortization Plan with Put Feature",
                "L": "Amortization Plan with Put and Call",
                "P": "Perpetual",
                "Q": "Perpetual with Call Feature",
                "R": "Perpetual with Put Feature",
                "E": "Extendible"
              }
            },
            {
              "position": 6,
              "name": "Form",
              "values": {
                "B": "Bearer",
                "R": "Registered",
                "N": "Bearer/Registered",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "N",
          "name": "Municipal bonds",
          "attributes": [
            {
              "position": 3,
              "name": "Type of interest",
              "values": {
                "F": "Fixed rate",
                "Z": "Zero rate / discounted rate",
                "V": "Variable",
                "C": "Cash payment",
                "K": "Payment in kind"
              }
            },
            {
              "position": 4,
              "name": "Guarantee",
              "values": {
                "T": "Government / State Guarantee",
                "G": "Joint Guarantee",
                "S": "Secured",
                "U": "Unsecured / Unguaranteed",
                "P": "Negative Pledge",
                "N": "Senior",
                "O": "Senior Subordinated",
                "Q": "Junior",
                "J": "Junior Subordinated",
                "C": "Supranational"
              }
            },
            {
              "position": 5,
              "name": "Redemption/Reimbursement",
              "values": {
                "F": "Fixed Maturity",
                "G": "Fixed Maturity with Call Feature",
                "C": "Fixed Maturity with Put Feature",
                "D": "Fixed Maturity with Put and Call",
                "A": "Amortization Plan",
                "B": "Amortization Plan with Call Feature",
                "T": "Amortization Plan with Put Feature",
                "L": "Amortization Plan with Put and Call",
                "P": "Perpetual",
                "Q": "Perpetual with Call Feature",
                "R": "Perpetual with Put Feature",
                "E": "Extendible"
              }
            },
            {
              "position": 6,
              "name": "Form",
              "values": {
                "B": "Bearer",
                "R": "Registered",
                "N": "Bearer/Registered",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "D",
          "name": "Depository receipts on debt instruments",
          "attributes": [
            {
              "position": 3,
              "name": "Instrument dependency",
              "values": {
                "B": "Bonds",
                "C": "Convertible Bonds",
                "W": "Bonds with Warrants Attached",
                "T": "Medium-Term Notes",
                "Y": "Money Market Instruments",
                "G": "Mortgage-Backed Securities",
                "Q": "Asset-Backed Securities",
                "N": "Municipal Bonds",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 4,
              "name": "Type of interest/cash payment",
              "values": {
                "F": "Fixed Rate",
                "Z": "Zero Rate/Discounted",
                "V": "Variable",
                "C": "Cash Payment"
              }
            },
            {
              "position": 5,
              "name": "Guarantee",
              "values": {
                "T": "Government / State Guarantee",
                "G": "Joint Guarantee",
                "S": "Secured",
                "U": "Unsecured / Unguaranteed",
                "P": "Negative Pledge",
                "N": "Senior",
                "O": "Senior Subordinated",
                "Q": "Junior",
                "J": "Junior Subordinated",
                "C": "Supranational"
              }
            },
            {
              "position": 6,
              "name": "Redemption/Reimbursement",
              "values": {
                "F": "Fixed Maturity",
                "G": "Fixed Maturity with Call Feature",
                "C": "Fixed Maturity with Put Feature",
                "D": "Fixed Maturity with Put and Call",
                "A": "Amortization Plan",
                "B": "Amortization Plan with Call Feature",
                "T": "Amortization Plan with Put Feature",
                "L": "Amortization Plan with Put and Call",
                "P": "Perpetual",
                "Q": "Perpetual with Call Feature",
                "R": "Perpetual with Put Feature",
                "E": "Extendible"
              }
            }
          ]
        },
        {
          "code": "Y",
          "name": "Money market instruments",
          "attributes": [
            {
              "position": 3,
              "name": "Type of interest",
              "values": {
                "F": "Fixed Rate",
                "Z": "Zero Rate/Discounted",
                "V": "Variable",
                "K": "Payment in Kind"
              }
            },
            {
              "position": 4,
              "name": "Guarantee",
              "values": {
                "T": "Government / State Guarantee",
                "G": "Joint Guarantee",
                "S": "Secured",
                "U": "Unsecured / Unguaranteed",
                "P": "Negative Pledge",
                "N": "Senior",
                "O": "Senior Subordinated",
                "Q": "Junior",
                "J": "Junior Subordinated",
                "C": "Supranational"
              }
            },
            {
              "position": 6,
              "name": "Form",
              "values": {
                "B": "Bearer",
                "R": "Registered",
                "N": "Bearer/Registered",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "M",
          "name": "Others (Misc.)",
          "attributes": [
            {
              "position": 3,
              "name": "Type",
              "values": {
                "B": "Bank Loan",
                "P": "Promissory Note",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 6,
              "name": "Form",
              "values": {
                "B": "Bearer",
                "R": "Registered",
                "N": "Bearer/Registered",
                "M": "Others (Misc.)"
              }
            }
          ]
        }
      ]
    },
    {
      "code": "C",
      "name": "Collective Investment Vehicles",
      "groups": [
        {
          "code": "I",
          "name": "Standard (vanilla) investment funds / mutual funds",
          "attributes": [
            {
              "position": 3,
              "name": "Closed / Open-end",
              "values": {
                "O": "Open-End",
                "C": "Closed-End",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 4,
              "name": "Distribution Policy",
              "values": {
                "I": "Income Funds",
                "G": "Accumulation Funds",
                "J": "Mixed Funds"
              }
            },
            {
              "position": 5,
              "name": "Asset",
              "values": {
                "R": "Real Estate",
                "B": "Debt Instruments",
                "E": "Equities",
                "V": "Convertible Securities",
                "L": "Mixed",
                "C": "Commodities",
                "D": "Derivatives",
                "F": "Referential Instruments",
                "K": "Credits",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 6,
              "name": "Security Type and Investors Restrictions",
              "values": {
                "S": "Shares",
                "Q": "Shares for QI",
                "U": "Units",
                "Y": "Units for QI"
              }
            }
          ]
        },
        {
          "code": "H",
          "name": "Hedge funds",
          "attributes": []
        },
        {
          "code": "B",
          "name": "Real estate investment trusts (REITs)",
          "attributes": []
        },
        {
          "code": "E",
          "name": "Exchange-traded funds (ETFs)",
          "attributes": []
        },
        {
          "code": "S",
          "name": "Pension funds",
          "attributes": []
        },
        {
          "code": "F",
          "name": "Funds of funds",
          "attributes": []
        },
        {
          "code": "P",
          "name": "Private equity funds",
          "attributes": []
        },
        {
          "code": "M",
          "name": "Others (Misc.)",
          "attributes": [
            {
              "position": 6,
              "name": "Security Type and Investors Restrictions",
              "values": {
                "S": "Shares",
                "Q": "Shares for QI",
                "U": "Units",
                "Y": "Units for QI"
              }
            }
          ]
        }
      ]
    },
    {
      "code": "R",
      "name": "Entitlement (Rights)",
      "groups": [
        {
          "code": "A",
          "name": "Allotments (Bonus Rights)",
          "attributes": [
            {
              "position": 6,
              "name": "Form",
              "values": {
                "B": "Bearer",
                "R": "Registered",
                "N": "Bearer/Registered",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "S",
          "name": "Subscription Rights",
          "attributes": [
            {
              "position": 3,
              "name": "Asset",
              "values": {
                "S": "Common/Ordinary Shares",
                "P": "Preferred/Preference Shares",
                "C": "Common/Ordinary Convertible Shares",
                "F": "Preferred/Preference Convertible Shares",
                "B": "Bonds",
                "I": "Combined Instruments",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 6,
              "name": "Form",
              "values": {
                "B": "Bearer",
                "R": "Registered",
                "N": "Bearer/Registered",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "P",
          "name": "Purchase Rights",
          "attributes": [
            {
              "position": 3,
              "name": "Asset",
              "values": {
                "S": "Common/Ordinary Shares",
                "P": "Preferred/Preference Shares",
                "C": "Common/Ordinary Convertible Shares",
                "F": "Preferred/Preference Convertible Shares",
                "B": "Bonds",
                "I": "Combined Instruments",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 6,
              "name": "Form",
              "values": {
                "B": "Bearer",
                "R": "Registered",
                "N": "Bearer/Registered",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "W",
          "name": "Warrants",
          "attributes": [
            {
              "position": 3,
              "name": "Underlying asset",
              "values": {
                "B": "Baskets",
                "S": "Equities",
                "D": "Debt Instruments/Interest Rates",
                "T": "Commodities",
                "C": "Currencies",
                "I": "Indices",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 4,
              "name": "Type",
              "values": {
                "T": "Traditional Warrants",
                "N": "Naked Warrants",
                "C": "Covered Warrants"
              }
            },
            {
              "position": 5,
              "name": "Call / Put",
              "values": {
                "C": "Call",
                "P": "Put",
                "B": "Call and Put"
              }
            },
            {
              "position": 6,
              "name": "Exercise Option Style",
              "values": {
                "A": "American",
                "E": "European",
                "B": "Bermudan",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "F",
          "name": "Mini-future certificates / constant leverage certificates",
          "attributes": [
            {
              "position": 3,
              "name": "Underlying asset",
              "values": {
                "B": "Baskets",
                "S": "Equities",
                "D": "Debt Instruments/Interest Rates",
                "T": "Commodities",
                "C": "Currencies",
                "I": "Indices",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 4,
              "name": "Barrier dependency type",
              "values": {
                "T": "Barrier Underlying Based",
                "N": "Barrier Instrument Based",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 5,
              "name": "Long / short",
              "values": {
                "C": "Long",
                "P": "Short",
                "M": "Others (Misc.)"
              }
            }
          ]
        }
      ]
    },
    {
      "code": "O",
      "name": "Listed Options",
      "groups": [
        {
          "code": "C",
          "name": "Call Options",
          "attributes": [
            {
              "position": 3,
              "name": "Exercise option style",
              "values": {
                "A": "American",
                "E": "European",
                "B": "Bermudan"
              }
            },
            {
              "position": 4,
              "name": "Underlying asset",
              "values": {
                "B": "Baskets",
                "S": "Stock-Equities",
                "D": "Debt Instruments",
                "T": "Commodities",
                "C": "Currencies",
                "I": "Indices",
                "O": "Options",
                "F": "Futures",
                "W": "Swaps",
                "N": "Interest Rates",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 5,
              "name": "Delivery",
              "values": {
                "P": "Physical",
                "C": "Cash",
                "N": "Non-Deliverable"
              }
            },
            {
              "position": 6,
              "name": "Standardized / Non-Standardized",
              "values": {
                "S": "Standardized",
                "N": "Non-Standardized"
              }
            }
          ]
        },
        {
          "code": "P",
          "name": "Put Options",
          "attributes": [
            {
              "position": 3,
              "name": "Exercise option style",
              "values": {
                "A": "American",
                "E": "European",
                "B": "Bermudan"
              }
            },
            {
              "position": 4,
              "name": "Underlying asset",
              "values": {
                "B": "Baskets",
                "S": "Stock-Equities",
                "D": "Debt Instruments",
                "T": "Commodities",
                "C": "Currencies",
                "I": "Indices",
                "O": "Options",
                "F": "Futures",
                "W": "Swaps",
                "N": "Interest Rates",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 5,
              "name": "Delivery",
              "values": {
                "P": "Physical",
                "C": "Cash",
                "N": "Non-Deliverable"
              }
            },
            {
              "position": 6,
              "name": "Standardized / Non-Standardized",
              "values": {
                "S": "Standardized",
                "N": "Non-Standardized"
              }
            }
          ]
        },
        {
          "code": "M",
          "name": "Others (Misc.)",
          "attributes": []
        }
      ]
    },
    {
      "code": "F",
      "name": "Futures",
      "groups": [
        {
          "code": "F",
          "name": "Financial futures",
          "attributes": [
            {
              "position": 3,
              "name": "Underlying Asset",
              "values": {
                "B": "Baskets",
                "S": "Stock-Equities",
                "D": "Debt Instruments",
                "C": "Currencies",
                "I": "Indices",
                "O": "Options",
                "F": "Futures",
                "W": "Swaps",
                "N": "Interest Rates",
                "V": "Stock Dividend",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 4,
              "name": "Delivery",
              "values": {
                "P": "Physical",
                "C": "Cash",
                "N": "Non-Deliverable"
              }
            },
            {
              "position": 5,
              "name": "Standardized / Non-Standardized",
              "values": {
                "S": "Standardized",
                "N": "Non-Standardized"
              }
            }
          ]
        },
        {
          "code": "C",
          "name": "Commodities futures",
          "attributes": [
            {
              "position": 3,
              "name": "Underlying Asset",
              "values": {
                "B": "Baskets",
                "S": "Stock-Equities",
                "D": "Debt Instruments",
                "C": "Currencies",
                "I": "Indices",
                "O": "Options",
                "F": "Futures",
                "W": "Swaps",
                "N": "Interest Rates",
                "V": "Stock Dividend",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 4,
              "name": "Delivery",
              "values": {
                "P": "Physical",
                "C": "Cash",
                "N": "Non-Deliverable"
              }
            },
            {
              "position": 5,
              "name": "Standardized / Non-Standardized",
              "values": {
                "S": "Standardized",
                "N": "Non-Standardized"
              }
            }
          ]
        }
      ]
    },
    {
      "code": "T",
      "name": "Referential instruments",
      "groups": [
        {
          "code": "C",
          "name": "Currencies",
          "attributes": [
            {
              "position": 3,
              "name": "Type",
              "values": {
                "N": "National Currency",
                "L": "Legacy Currency",
                "C": "Bullion Coins",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "T",
          "name": "Commodities",
          "attributes": [
            {
              "position": 3,
              "name": "Underlying asset",
              "values": {
                "E": "Extraction Resources",
                "A": "Agriculture",
                "I": "Industrial Products",
                "S": "Services",
                "N": "Environmental",
                "P": "Polypropylene Products",
                "H": "Generated Resources",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "R",
          "name": "Interest rates",
          "attributes": [
            {
              "position": 3,
              "name": "Type",
              "values": {
                "N": "Nominal",
                "V": "Variable",
                "F": "Fixed",
                "R": "Real",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 4,
              "name": "Frequency of calculation",
              "values": {
                "D": "Daily",
                "W": "Weekly",
                "N": "Monthly",
                "Q": "Quarterly",
                "S": "Semi-Annually",
                "A": "Annually",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "I",
          "name": "Indices",
          "attributes": [
            {
              "position": 3,
              "name": "Asset class",
              "values": {
                "E": "Equities",
                "D": "Debt",
                "F": "Collective Investment Vehicles",
                "R": "Real Estate",
                "T": "Commodities",
                "C": "Currencies",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 4,
              "name": "Weighting type",
              "values": {
                "P": "Price Weighted",
                "C": "Capitalization Weighted",
                "E": "Equal Weighted",
                "F": "Modified Market Capitalization Weighted",
                "M": "Others (Misc.)"
              }
            },
            {
              "position": 5,
              "name": "Index return type",
              "values": {
                "P": "Price Return",
                "N": "Net Total Return",
                "G": "Gross Total Return",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "B",
          "name": "Baskets",
          "attributes": [
            {
              "position": 3,
              "name": "Composition",
              "values": {
                "E": "Equities",
                "D": "Debt",
                "F": "Collective Investment Vehicles",
                "I": "Indices",
                "T": "Commodities",
                "C": "Currencies",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "D",
          "name": "Stock dividends",
          "attributes": [
            {
              "position": 3,
              "name": "Type of equity",
              "values": {
                "S": "Common Ordinary Shares",
                "P": "Preferred/Preference Shares",
                "C": "Common Ordinary Convertible Shares",
                "F": "Preferred/Preference Convertible Shares",
                "L": "Limited Partnership Units",
                "K": "Collective Investment Vehicles",
                "M": "Others (Misc.)"
              }
            }
          ]
        },
        {
          "code": "M",
          "name": "Misc. / Others",
          "attributes": [
            {
              "code": "C",
              "name": "Combined instruments",
              "attributes": [
                {
                  "position": 3,
                  "name": "Component",
                  "values": {
                    "S": "Combination of Shares",
                    "B": "Combination of Bonds",
                    "H": "Share and Bond",
                    "A": "Share and Warrant",
                    "W": "Warrant and Warrant",
                    "U": "Fund Units and Other Components",
                    "M": "Others (Misc.)"
                  }
                },
                {
                  "position": 4,
                  "name": "Ownership",
                  "values": {
                    "T": "Restrictions",
                    "U": "Free"
                  }
                },
                {
                  "position": 6,
                  "name": "Form",
                  "values": {
                    "B": "Bearer",
                    "R": "Registered",
                    "N": "Bearer/Registered",
                    "M": "Others (Misc.)"
                  }
                }
              ]
            },
            {
              "code": "M",
              "name": "Misc. / Others (further grouping)",
              "attributes": [
                {
                  "position": 3,
                  "name": "Further grouping",
                  "values": {
                    "R": "Real Estate Deeds",
                    "I": "Insurance Policies",
                    "E": "Escrow Receipts",
                    "T": "Trade Finance Instruments",
                    "N": "Carbon Credit",
                    "P": "Precious Metal Receipts",
                    "S": "Other OTC Derivative Products",
                    "M": "Others (Misc.)"
                  }
                }
              ]
            }
          ]
        }
      ]
    }
  ]
};

    (async function init() {
      try {
        drawTree(embeddedCFI);
      } catch (err) {
        const box = document.getElementById('err');
        box.style.display = 'block';
        box.textContent = "Failed to draw tree: " + (err && err.message ? err.message : err);
      }
    })();

    function transformToHierarchy(cfi) {
      // cfi.categories: [{code, name, groups:[{code,name,attributes:[{position,name,values:{code:label}}]}]}]
      const root = { name: cfi.name || "ISO 10962 (CFI)", children: [] };

      // Determine max depth by calculating actual tree depth for each group
      let maxDepth = 0;
      for (const cat of (cfi.categories || [])) {
        for (const grp of (cat.groups || [])) {
          const depth = calculateGroupDepth(grp.attributes || []);
          if (depth > maxDepth) maxDepth = depth;
        }
      }

      for (const cat of (cfi.categories || [])) {
        const catNode = { type: "category", code: cat.code, name: `${cat.code} — ${cat.name}`, children: [] };

        for (const grp of (cat.groups || [])) {
          const grpNode = { type: "group", code: grp.code, name: `${grp.code} — ${grp.name}`, children: [] };

          // Build an attribute tower: Attr-3 -> (values) -> Attr-4 -> ... -> Attr-6
          const attrs = Array.isArray(grp.attributes) ? grp.attributes.slice().sort((a,b)=>a.position-b.position) : [];

          if (attrs.length === 0) {
            // Pad with placeholder levels to reach maxDepth
            grpNode.children.push(createPaddingLevels(maxDepth));
          } else {
            const currentDepth = calculateGroupDepth(attrs);
            grpNode.children = processAttributes(attrs, maxDepth, 0);
          }

          catNode.children.push(grpNode);
        }
        root.children.push(catNode);
      }

      function calculateGroupDepth(attrs) {
        if (!attrs || attrs.length === 0) return 0;

        // Check if this has nested structure (subgroups)
        if (attrs[0].attributes) {
          // Nested structure: count subgroups + their attributes
          let maxSubDepth = 0;
          for (const subGrp of attrs) {
            const subDepth = calculateGroupDepth(subGrp.attributes || []);
            if (subDepth > maxSubDepth) maxSubDepth = subDepth;
          }
          return 1 + maxSubDepth; // 1 for subgroup level + max subgroup depth
        } else {
          // Normal structure: calculate based on position span (not count)
          // Some groups skip positions (e.g., 3,4,6 skips 5)
          // We need to account for all positions from min to max
          const positions = attrs.map(a => a.position).filter(p => p != null);
          if (positions.length === 0) return 0;

          const minPos = Math.min(...positions);
          const maxPos = Math.max(...positions);
          const span = maxPos - minPos + 1; // Total positions from min to max

          return span * 2; // Each position slot = 2 levels (attr + value)
        }
      }

      function processAttributes(attrs, targetDepth, currentDepth) {
        if (!attrs || attrs.length === 0) {
          const remaining = targetDepth - currentDepth;
          if (remaining > 0) {
            return [createPaddingLevels(remaining)];
          }
          return [];
        }

        // Check if nested structure (has subgroups like T/M)
        if (attrs[0].attributes) {
          // First, find the max depth among all subgroups
          let maxSubDepth = 0;
          for (const subGrp of attrs) {
            const subAttrs = subGrp.attributes || [];
            const subDepth = calculateGroupDepth(subAttrs);
            if (subDepth > maxSubDepth) maxSubDepth = subDepth;
          }

          const nodes = [];
          for (const subGrp of attrs) {
            const subNode = {
              type: "subgroup",
              code: subGrp.code,
              name: `${subGrp.code} — ${subGrp.name}`,
              children: []
            };
            const subAttrs = subGrp.attributes || [];
            // Use maxSubDepth to ensure all subgroups have the same depth
            subNode.children = processAttributes(subAttrs, maxSubDepth, 0);
            nodes.push(subNode);
          }
          return nodes;
        } else {
          // Normal attributes - need to handle position gaps
          const attr = attrs[0];
          const node = { type: "attr", name: `(${attr.position}) ${attr.name}`, attrPos: attr.position, children: [] };
          const entries = Object.entries(attr.values || {});

          if (entries.length === 0) {
            const remaining = targetDepth - currentDepth - 1;
            if (remaining > 0) {
              node.children.push(createPaddingLevels(remaining));
            }
            return [node];
          }

          for (const [valCode, valLabel] of entries) {
            const valNode = { type: "attrValue", code: valCode, name: `${valCode} — ${valLabel}`, children: [] };

            if (attrs.length > 1) {
              // Check if next attribute skips positions
              const nextAttr = attrs[1];
              const currentPos = attr.position;
              const nextPos = nextAttr.position;
              const gap = (nextPos - currentPos - 1) * 2; // Each skipped position = 2 levels

              if (gap > 0) {
                // Add padding for skipped positions, then continue with remaining attrs
                const paddingNode = createPaddingLevels(gap);
                if (paddingNode) {
                  paddingNode.children = processAttributes(attrs.slice(1), targetDepth, currentDepth + 2 + gap);
                  valNode.children.push(paddingNode);
                } else {
                  valNode.children = processAttributes(attrs.slice(1), targetDepth, currentDepth + 2 + gap);
                }
              } else {
                valNode.children = processAttributes(attrs.slice(1), targetDepth, currentDepth + 2);
              }
            } else {
              const remaining = targetDepth - currentDepth - 2;
              if (remaining > 0) {
                valNode.children.push(createPaddingLevels(remaining));
              }
            }

            node.children.push(valNode);
          }
          return [node];
        }
      }
      return root;

      function createPaddingLevels(levelsNeeded) {
        if (levelsNeeded === 0) return null;

        const node = { type: "padding", name: "—", children: [] };
        const child = createPaddingLevels(levelsNeeded - 1);
        if (child) node.children.push(child);
        return node;
      }

    }

    function drawTree(cfi) {
      const data = transformToHierarchy(cfi);

      // ---- Dimensions ----
      const width = 1300, height = 1300;
      const outerRadius = Math.min(width, height) / 2;
      const innerRadius = outerRadius - 180;     // drawing radius
      const labelPadding = 10;                   // gap so labels don't overlap lines

      // ---- Colors ----
      const categories = (cfi.categories || []).map(d => d.code);
      const categoryNames = Object.fromEntries((cfi.categories || []).map(d => [d.code, d.name]));
      const categoryColors = d3.scaleOrdinal()
        .domain(categories)
        .range(d3.schemeTableau10.slice(0, categories.length)); // distinct palette

      // ---- SVG ----
      const svg = d3.select("#container").append("svg")
        .attr("width", width).attr("height", height)
        .attr("viewBox", [-width/2, -height/2, width, height])
        .attr("style", "max-width:100%;height:auto;");

      // ---- Layout ----
      // Create hierarchy but show only first level (categories)
      const root = d3.hierarchy(data, d => d.children)
        .sort((a,b) => d3.ascending(a.data.name, b.data.name));

      // Hide all levels except the first level (categories)
      const maxDepthVisible = 1;

      // Hide children of nodes at depth 1 (categories)
      root.each(d => {
        if (d.depth === 1) {
          d._children = d.children; // store original children
          d.children = null; // hide from layout
        }
      });

      const cluster = d3.cluster().size([360, innerRadius]).separation((a,b)=>1);
      cluster(root);

      // derive category (1st-level ancestor code) for each node
      root.each(d => {
        const a1 = d.ancestors().find(x => x.depth === 1);
        d.category = a1 && a1.data && a1.data.code || null;
      });

      const colorDepth = d3.scaleSequential().domain([0, maxDepthVisible]).interpolator(d3.interpolateTurbo);

      // ---- Path helpers (equal-depth) ----
      function linkStep(startAngle, startRadius, endAngle, endRadius) {
        const a0 = (startAngle - 90) / 180 * Math.PI;
        const a1 = (endAngle   - 90) / 180 * Math.PI;
        const c0 = Math.cos(a0), s0 = Math.sin(a0);
        const c1 = Math.cos(a1), s1 = Math.sin(a1);
        return "M" + (startRadius * c0) + "," + (startRadius * s0)
             + (a1 === a0 ? "" : "A" + startRadius + "," + startRadius
             + " 0 0 " + (a1 > a0 ? 1 : 0) + " " + (startRadius * c1) + "," + (startRadius * s1))
             + "L" + (endRadius * c1) + "," + (endRadius * s1);
      }
      function linkConstant(d) { return linkStep(d.source.x, d.source.y, d.target.x, d.target.y); }
      function linkExtensionConstant(d) { return linkStep(d.target.x, d.target.y, d.target.x, innerRadius - labelPadding); }

      // ---- Color mode plumbing ----
      const select = document.getElementById("color-mode");
      function linkStroke(d) {
        const node = d.target;
        if (select.value === "depth") return colorDepth(node.depth);
        return categoryColors(node.category || categories[0]);
      }
      function labelFill(d) {
        if (select.value === "depth") return colorDepth(d.depth);
        return categoryColors(d.category || categories[0]);
      }

      // ---- Links ----
      const link = svg.append("g").attr("fill","none").selectAll("path")
        .data(root.links())
        .join("path")
          .attr("class", "link")
          .each(function(d){ d.target.linkNode = this; })
          .attr("d", linkConstant)
          .attr("stroke", linkStroke);

      // ---- Link extensions (leaf stubs to just before the label ring) ----
      const linkExtension = svg.append("g")
        .attr("fill","none").attr("stroke","#000").attr("stroke-opacity",0.25)
        .selectAll("path")
        .data(root.links().filter(d => !d.target.children))
        .join("path")
          .each(function(d){ d.target.linkExtensionNode = this; })
          .attr("d", linkExtensionConstant);

      // ---- Labels (only leaves) ----
      const leaves = root.leaves();
      const labels = svg.append("g").selectAll("text")
        .data(leaves)
        .join("text")
          .attr("class","text-halo")
          .attr("dy",".31em")
          .attr("transform", d => `rotate(${d.x - 90}) translate(${innerRadius + labelPadding},0)${d.x < 180 ? "" : " rotate(180)"}`)
          .attr("text-anchor", d => d.x < 180 ? "start" : "end")
          .text(d => d.data.name)
          .attr("fill", labelFill)
          .style("font-size","10px")
          .on("mouseover", mouseovered(true))
          .on("mouseout", mouseovered(false));

      labels.append("title").text(d => d.data.name);

      function mouseovered(active) {
        return function(event, d) {
          d3.select(this).classed("label--active", active);
          if (d.linkExtensionNode) d3.select(d.linkExtensionNode).classed("link-extension--active", active).raise();
          do {
            if (d.linkNode) d3.select(d.linkNode).classed("link--active", active).raise();
            d = d.parent;
          } while (d);
        };
      }

      // ---- Legend ----
      const legend = d3.select("#legend");
      function renderLegend() {
        legend.selectAll("*").remove();
        const mode = select.value;

        if (mode === "category") {
          legend.append("div").text("Category (1st char)");
          categories.forEach(c => {
            const row = legend.append("div").attr("class","legend-item");
            row.append("div").attr("class","legend-color").style("background-color", categoryColors(c));
            row.append("span").text(`${c} — ${categoryNames[c] || ""}`);
          });
        } else {
          const w = 160, h = 12;
          const canvas = legend.append("canvas").attr("width", w).attr("height", h).node();
          const ctx = canvas.getContext("2d");
          const n = w;
          for (let i = 0; i < n; ++i) {
            const t = i / (n - 1);
            ctx.fillStyle = colorDepth(t * maxDepthVisible);
            ctx.fillRect(i, 0, 1, h);
          }
          legend.append("div").style("margin-top","6px").text(`Depth (levels): 0 → ${maxDepthVisible}`);
        }
      }
      renderLegend();

      // ---- Live updates (links, labels, legend) ----
      select.addEventListener("change", () => {
        link.attr("stroke", linkStroke);
        labels.attr("fill", labelFill);
        renderLegend();
      });
    }
  </script>
</body>
</html>
